generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Identity {
  pubkey     String   @id
  name       String   @unique
  created_at BigInt 
  last_used  BigInt?
  is_active  Boolean  @default(true)
}

model Project {
  id                    Int       @id @default(autoincrement())
  uuid                  String    @unique
  name                  String
  description           String?
  is_private            Boolean   @default(false)
  created_at            BigInt
  last_event_id         String?
  last_event_created_at BigInt?
  members               ProjectMember[]
  tickets               Ticket[]
}

model ProjectMember {
  project_id  Int
  pubkey      String
  role        String    @default("admin")
  created_at  BigInt
  project     Project   @relation(fields: [project_id], references: [id], onDelete: Cascade)
  @@id([project_id, pubkey])
}

model Ticket{
  id                    Int       @id @default(autoincrement())
  uuid                  String    @unique
  project_id            Int
  type                  String
  title                 String
  description           String?
  state                 String    @default("unscheduled")
  parent_id             Int?
  owner_pubkey          String?
  created_at            BigInt
  updated_at            BigInt
  last_event_id         String?
  last_event_created_at BigInt?
  project               Project   @relation(fields: [project_id], references: [id], onDelete: Cascade)
  parent                Ticket? @relation("TicketParent", fields: [parent_id], references: [id], onDelete: SetNull)
  children              Ticket[] @relation("TicketParent")
  referencesFrom        TicketReference[] @relation("SourceTicket")
  referencesTo          TicketReference[] @relation("TargetTicket")
}

model TicketReference {
  source_ticket_id  Int
  target_ticket_id  Int
  reference_type    String
  created_at        BigInt
  source_ticket     Ticket @relation("SourceTicket", fields: [source_ticket_id], references: [id], onDelete: Cascade)
  target_ticket     Ticket @relation("TargetTicket", fields: [target_ticket_id], references: [id], onDelete: Cascade)
  @@id([source_ticket_id, target_ticket_id, reference_type])
}

model ProcessedEvent {
  event_id    String   @id
  received_at BigInt
}